<!DOCTYPE html>
<html>

<head>
    <title>test editor app</title>
    <script src="../lib/paper-full.min.js"></script>
    <script src="../lib/dat.gui.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body,
        html {
            height: 100%;
            background-color: #222;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>

    <script type="text/javascript">
        window.onload = _ => {
            paper.install(window);
            paper.setup('canvas');

            setupPaper();
            setupGUI();
        }

        var layers = [];

        setupGUI = _ => {
            // Build the GUI
            //create a params object with activeTool, clearCanvas
            var params = {
                activeTool: 'edit',
                activeLayer: 'layer0',
                clearCanvas: _ => { },
                addLayer: _ => { },

            };

            ////create a dat.gui
            var gui = new dat.GUI();

            gui.add(params, 'activeTool',
                ['edit', 'select', 'erase']).name('tool');

            gui.add(params, 'clearCanvas').name('clear canvas').onChange(_ => {
                paper.project.activeLayer.clear();
            });

            //add a button to the gui to add a new layer
            gui.add(params, 'addLayer').name('add layer').onChange(_ => {
                var newLayer = new paper.Layer({
                    name: 'layer' + (layers.length),
                    visible: true,
                    opacity: 1,
                    locked: false,
                    color: '#ff0000'
                });

                layers.push(newLayer);
                newLayer.activate();

                // console.log(layers.map(l => l.name));
                layerlist.remove();
                layerlist = gui.add(params, 'activeLayer',
                    layers.map(l => l.name)).name('layer')
                    .onChange(updateActiveLayer).listen();
            });

            //update the dropdown menu choices with the names of the layers
            const updateLayerList = name => {
                paper.project.activeLayer = layers.find(l => l.name == name);
                let l = layers.find(l => l.name === value);
                console.log(value + " " + l.name + " " + paper.project.activeLayer.name);

            };

            const updateActiveLayer = name => {
                let newactivelayer = layers.find(l => l.name === name);
                newactivelayer.activate();
                console.log(newactivelayer.name + " " + paper.project.activeLayer.name);
            }

            const layerlist = gui.add(params, 'activeLayer',
                paper.project.layers.map(l => l.name)).
                name('layer').onChange(updateActiveLayer).listen();

            gui.domElement.style.display = 'none';
            //setup keybinding for alt+v or esc to toggle dat.gui visibility on/off

            document.addEventListener('keydown', e => {
                if ((e.keyCode == 27) || (e.keyCode == 86 && e.altKey)) {
                    gui.domElement.style.display = gui.domElement.style.display == 'none' ? 'block' : 'none';
                }
            });

        };

        //on resize window rebuild the paper project
        window.onresize = _ => {
            paper.view.viewSize = new paper.Size(window.innerWidth, window.innerHeight);
            setupPaper();

        };

        const setupPaper = _ => {
            //clear the paper project
            paper.project.clear();
            layers = [];
            layers.push(new paper.Layer({
                name: 'layer0',
                visible: true,
                opacity: 1,
                locked: false,
                color: 'none'
            }));

            layers.push(new paper.Layer({
                name: 'layer1',
                visible: true,
                opacity: 1,
                locked: false,
                color: '#ffff00'
            }));
            layers[0].activate();
            drawBackgroundGrid(25,'blue');
            layers[1].activate();
            drawBackgroundGrid(100,'yellow');

        }

        ////////////////////
        //// draw background grid
        const drawBackgroundGrid = (n = 20, color1 = 'red', color2 = 'lightblue') => {
            //draw a square n x n grid with thin black lines on the background layer
            //const n = 20;
            console.log(n);
            const viewsize = paper.view.size;
            const grid = new paper.Path.Rectangle({
                rectangle: [n, n,
                    paper.view.size.width - 2*n, paper.view.size.height - 2*n],
                fillColor: color1,
                strokeColor: 'none',
                opacity: .5
            })
            let aspect = paper.view.size.width / paper.view.size.height;
            aspect = 1;
            let gridstep = { x: n, y: n };
            let nsteps = Math.max(paper.view.size.width, paper.view.size.height) /
                Math.min(gridstep.x, gridstep.y);

            for (let i = 0; i < nsteps; i++) {
                let x = i * gridstep.x;
                let y = aspect * i * gridstep.y;
                let line = new paper.Path.Line({
                    from: [x, 0],
                    to: [x, paper.view.size.height],
                    strokeColor: color2,
                    strokeWidth: 1
                });
                // line.sendToFront();
                let line2 = new paper.Path.Line({
                    from: [0, y],
                    to: [paper.view.size.width, y],
                    strokeColor: color2,
                    strokeWidth: 1
                });
                //line2.sendToBack();
            }

        }


    </script>
</body>

</html>